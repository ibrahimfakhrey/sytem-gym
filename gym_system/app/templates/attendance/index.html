{% extends "base.html" %}

{% block title %}تسجيل الحضور{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="bi bi-check2-square"></i> تسجيل الحضور</h1>
</div>

<!-- Check-in Box -->
<div class="row justify-content-center mb-4">
    <div class="col-lg-8">
        <div class="check-in-box">
            <h4 class="mb-4">
                <i class="bi bi-search"></i>
                تسجيل حضور عضو
            </h4>

            <div class="mb-3">
                <input type="text" id="member-search" class="form-control search-input"
                       placeholder="ابحث برقم الهاتف أو الاسم..."
                       autocomplete="off">
            </div>

            <!-- Search Results -->
            <div id="search-results" class="mt-3" style="display: none;">
            </div>

            <!-- Check-in Result -->
            <div id="check-in-result" class="check-in-result" style="display: none;">
            </div>
        </div>
    </div>
</div>

<!-- Today's Attendance -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-calendar-check"></i> حضور اليوم</span>
        <span class="badge bg-primary">{{ today_attendance|length }} عضو</span>
    </div>
    <div class="card-body">
        {% if today_attendance %}
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>العضو</th>
                        <th>الهاتف</th>
                        <th>وقت الحضور</th>
                        <th>المصدر</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody>
                    {% for att in today_attendance %}
                    <tr>
                        <td>
                            <a href="{{ url_for('members.view', member_id=att.member.id) }}">
                                {{ att.member.name }}
                            </a>
                        </td>
                        <td>{{ att.member.phone }}</td>
                        <td>{{ att.check_in.strftime('%H:%M:%S') }}</td>
                        <td>
                            {% if att.source == 'fingerprint' %}
                            <span class="badge bg-info"><i class="bi bi-fingerprint"></i> بصمة</span>
                            {% elif att.source == 'manual' %}
                            <span class="badge bg-secondary"><i class="bi bi-hand-index"></i> يدوي</span>
                            {% else %}
                            <span class="badge bg-dark"><i class="bi bi-qr-code"></i> QR</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('members.view', member_id=att.member.id) }}"
                               class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-eye"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="bi bi-calendar-x"></i>
            <h5>لا يوجد حضور اليوم</h5>
            <p class="text-muted">ابحث عن عضو لتسجيل حضوره</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('member-search');
    const searchResults = document.getElementById('search-results');
    const checkInResult = document.getElementById('check-in-result');
    let searchTimeout;

    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();

        if (query.length < 2) {
            searchResults.style.display = 'none';
            return;
        }

        searchTimeout = setTimeout(() => {
            fetch(`{{ url_for('attendance.search_member') }}?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.results && data.results.length > 0) {
                        let html = '<div class="list-group">';
                        data.results.forEach(member => {
                            const statusClass = member.can_check_in ? 'success' : 'danger';
                            const statusText = member.can_check_in ? 'يمكنه الحضور' : member.message;
                            html += `
                                <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                     onclick="checkIn(${member.id})" style="cursor: pointer;">
                                    <div>
                                        <strong>${member.name}</strong>
                                        <br><small class="text-muted">${member.phone}</small>
                                    </div>
                                    <span class="badge bg-${statusClass}">${statusText}</span>
                                </div>
                            `;
                        });
                        html += '</div>';
                        searchResults.innerHTML = html;
                        searchResults.style.display = 'block';
                    } else {
                        searchResults.innerHTML = '<p class="text-muted">لم يتم العثور على نتائج</p>';
                        searchResults.style.display = 'block';
                    }
                });
        }, 300);
    });

    window.checkIn = function(memberId) {
        fetch(`{{ url_for('attendance.check_in') }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ member_id: memberId })
        })
        .then(response => response.json())
        .then(data => {
            searchResults.style.display = 'none';
            searchInput.value = '';

            if (data.success) {
                checkInResult.className = 'check-in-result success';
                checkInResult.innerHTML = `
                    <i class="bi bi-check-circle display-4 text-success"></i>
                    <h4 class="mt-2">${data.member_name}</h4>
                    <p class="text-success mb-0">تم تسجيل الحضور بنجاح</p>
                `;
            } else {
                checkInResult.className = 'check-in-result error';
                checkInResult.innerHTML = `
                    <i class="bi bi-x-circle display-4 text-danger"></i>
                    <h4 class="mt-2">فشل تسجيل الحضور</h4>
                    <p class="text-danger mb-0">${data.message}</p>
                `;
            }

            checkInResult.style.display = 'block';

            // Auto hide and reload after 3 seconds
            setTimeout(() => {
                location.reload();
            }, 2000);
        });
    };
});
</script>
{% endblock %}
