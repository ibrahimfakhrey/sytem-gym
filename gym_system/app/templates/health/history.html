{% extends "base.html" %}

{% block title %}سجل التقارير الصحية - {{ member.name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>
        <i class="bi bi-clock-history"></i>
        سجل التقارير الصحية - {{ member.name }}
    </h1>
    <a href="{{ url_for('health.create_report', member_id=member.id) }}" class="btn btn-primary">
        <i class="bi bi-plus-lg"></i>
        تقرير جديد
    </a>
</div>

<div class="card">
    <div class="card-body">
        {% if reports %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>التاريخ</th>
                        <th>الطول</th>
                        <th>الوزن</th>
                        <th>BMI</th>
                        <th>التصنيف</th>
                        <th>الوزن المثالي</th>
                        <th>الفرق</th>
                        <th>الحالة</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody>
                    {% for report in reports %}
                    <tr>
                        <td>{{ report.created_at.strftime('%Y-%m-%d') }}</td>
                        <td>{{ report.height_cm }} سم</td>
                        <td>{{ report.weight_kg }} كجم</td>
                        <td>
                            <strong class="text-{{ report.status_class }}">{{ report.bmi }}</strong>
                        </td>
                        <td>
                            <span class="badge bg-{{ report.status_class }}">{{ report.bmi_category }}</span>
                        </td>
                        <td>{{ report.ideal_weight }} كجم</td>
                        <td>
                            {% if report.weight_difference %}
                                {% if report.weight_difference > 0 %}
                                <span class="text-warning">+{{ report.weight_difference }}</span>
                                {% elif report.weight_difference < 0 %}
                                <span class="text-info">{{ report.weight_difference }}</span>
                                {% else %}
                                <span class="text-success">0</span>
                                {% endif %}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-{{ report.status_class }}">{{ report.status_arabic }}</span>
                        </td>
                        <td>
                            <div class="btn-group">
                                <a href="{{ url_for('health.print_report', report_id=report.id) }}"
                                   class="btn btn-sm btn-outline-secondary" target="_blank" title="طباعة">
                                    <i class="bi bi-printer"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Progress Chart -->
        <div class="mt-4">
            <h5><i class="bi bi-graph-up"></i> تطور الوزن</h5>
            <canvas id="weightChart" height="100"></canvas>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-clock-history display-1 text-muted"></i>
            <h4 class="mt-3">لا توجد تقارير سابقة</h4>
            <a href="{{ url_for('health.create_report', member_id=member.id) }}" class="btn btn-primary mt-2">
                <i class="bi bi-plus-lg"></i>
                إنشاء تقرير جديد
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if reports %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('weightChart').getContext('2d');
const reports = {{ reports | map(attribute='weight_kg') | list | tojson }};
const dates = {{ reports | map(attribute='created_at') | list | map('strftime', '%Y-%m-%d') | list | tojson }};
const idealWeights = {{ reports | map(attribute='ideal_weight') | list | tojson }};

new Chart(ctx, {
    type: 'line',
    data: {
        labels: dates.reverse(),
        datasets: [{
            label: 'الوزن الفعلي',
            data: reports.reverse(),
            borderColor: '#2196F3',
            backgroundColor: 'rgba(33, 150, 243, 0.1)',
            fill: true,
            tension: 0.3
        }, {
            label: 'الوزن المثالي',
            data: idealWeights.reverse(),
            borderColor: '#4CAF50',
            borderDash: [5, 5],
            fill: false
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'top'
            }
        },
        scales: {
            y: {
                beginAtZero: false,
                title: {
                    display: true,
                    text: 'الوزن (كجم)'
                }
            }
        }
    }
});
</script>
{% endif %}
{% endblock %}
